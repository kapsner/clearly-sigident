---
title: "sigident - Howto SVM-KNN-RF"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sigident-Howto_SVM-KNN-RF}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

The R package `sigident` is the core package of the `sigident` package framework. This framework consists of several packages which can be used to perform analyses of gene signatures. The following packages are included in the framework: 
* Core package: [sigident](https://github.com/miracum/clearly-sigident) 
* Data preprocessing: [sigident.preproc](https://github.com/miracum/clearly-sigident.preproc) 
* Functional analyses: [sigident.func](https://github.com/miracum/clearly-sigident.func)  

**Please view the [main vignette](https://github.com/miracum/clearly-sigident/blob/master/vignettes/sigident-Howto_Microarray.Rmd) for a detailled explanation of the specific workflow steps presented within this vignette.**

# Prerequisites and installation 

## Install sigident.preproc package

```{r eval = FALSE}
options('repos' = 'https://ftp.fau.de/cran/')
install.packages("devtools")
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.preproc.git",
                      upgrade = "always")
```

## Install sigident.func package

```{r eval = FALSE}
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.func.git",
                      upgrade = "always")
```

## Install sigident package

```{r eval = FALSE}
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.git")
```

# Preprocessing 

## Initialization of important variables

```{r setup}
library(sigident)
library(sigident.preproc)
library(sigident.func)
library(knitr)
library(caret)

# initialize filePath:
filePath <- tempdir()

# define datadir
maindir <- "./geodata/"
datadir <- paste0(maindir, "data/")
dir.create(maindir)
dir.create(datadir)

# define plotdir
plotdir <- "./plots/"
dir.create(plotdir)

# define idtype
idtype = "affy"
```

## Define list that contains a representation of the studies metadata

```{r}
studiesinfo <- list(
  "GSE18842" = list(
    setid = 1,
    targetcolname = "source_name_ch1",
    targetlevelname = "Human Lung Tumor",
    controllevelname = "Human Lung Control"
    ),
  
  "GSE19804" = list(
    setid = 1,
    targetcolname = "source_name_ch1",
    targetlevelname = "frozen tissue of primary tumor",
    controllevelname = "frozen tissue of adjacent normal"
  ),
  
  "GSE19188" = list(
    setid = 1,
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue type: healthy",
    targetlevelname = "tissue type: tumor",
    use_rawdata = TRUE
  )
)
```

## Load GEO datasets

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
sigident.preproc::load_geo_data(
  studiesinfo = studiesinfo,
  datadir = datadir,
  plotdir = plotdir,
  idtype = idtype,
  viz_batch_boxp = F,
  viz_batch_gpca = F
) 
```

# Preparations for utilizing the sigident package 


```{r}
# general
csvdir <- "./csv/"
dir.create(csvdir)

# diagnostic signature
seed <- 111
split <- 0.8
nfolds <- 10
```

# DEG analysis 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# define the false discovery rate here
fdr <- 0.05

genes <- sigident.func::identify_degs(mergeset = mergeset,
                                      diagnosis = diagnosis,
                                      q_value = fdr)
```

# Identification of diagnostic signatures 

## Split data into training and test dataset

```{r}
training_list <- sigident::create_training_test_split(
  diagnosis = diagnosis,
  mergeset = mergeset,
  split = split,
  seed = seed
)
```

For demonstration/ runtime purposes, the data is reduced to the first 1000 genes. If you want to run the analyses on the whole dataset, please comment out the following lines.

```{r}
training_list$train$x <- training_list$train$x[, 1:1000]
training_list$test$x <- training_list$test$x[, 1:1000]
```

## SVM 

A support vector machine is a collection of supervised learning algorithms that use hyperplane graphing to analyze new, unlabeled data. In Support Vector Machine incoming data is categorized into one of two classes. For SVM models, each data point is interpreted as a p-dimensional vector, which the machine attempts to create a linear classifier by fitting the data point inside a hyperplane (p-1 dimension). 
So for classification, every input is turned into a point in n-dimensional space (n being the number of features), and the value of each feature defined as the value of a unique coordinate on the hyperplane. Classification is determined by finding the hyperplane that most clearly separates the two classes. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_svm <- sigident::sigident_signature(
  traininglist = training_list,
  type = "svm",
  nfolds = nfolds,
  seed = seed
)
gc();gc();
filename <- paste0(plotdir, "SVM_model.png")
sigident::plot_grid_model_plot(
    model = diagnostic_svm$model,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "SVM_variable_importance.png")
sigident::plot_grid_varimp_plot(
    model = diagnostic_svm$model,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_SVM.png")
sigident::plot_rocplot(
    roc = diagnostic_svm$roc,
    filename = filename
)
gc();gc();
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

## Random Forest Regression 

The random forest regression is a supervised learning algorithm that randomly creates and merges multiple decision trees into one forest. The goal is not to rely on a single learning model, but rather a collection of decision models to improve accuracy. The primary difference between this approach and the standard decision tree algorithms is that the root nodes feature splitting nodes are generated randomly.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_rf <- sigident::sigident_signature(
  traininglist = training_list,
  type = "rf",
  nfolds = nfolds,
  seed = seed
)
gc();gc();
filename <- paste0(plotdir, "RF_model.png")
sigident::plot_grid_model_plot(
    model = diagnostic_rf$model,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "RF_variable_importance.png")
sigident::plot_grid_varimp_plot(
    model = diagnostic_rf$model,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_RF.png")
sigident::plot_rocplot(
    roc = diagnostic_rf$roc,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```


## K-Nearest Neighbors Regression 

The k-nearest neighbors algorithm, or kNN, is one of the simplest machine learning algorithms. Usually, k is a small, odd number - sometimes only 1. The larger k is, the more accurate the classification will be, but the longer it takes to perform the classification. It classifies an object into one of several classes by looking at the k elements of the training set that are closest to the one you want to classify, and letting them vote by majority on what that objectâ€™s class should be.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_knn <- sigident::sigident_signature(
  traininglist = training_list,
  type = "knn",
  nfolds = nfolds,
  seed = seed
)
filename <- paste0(plotdir, "KNN_model.png")
sigident::plot_grid_model_plot(
    model = diagnostic_knn$model,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "KNN_variable_importance.png")
sigident::plot_grid_varimp_plot(
    model = diagnostic_knn$model,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_KNN.png")
sigident::plot_rocplot(
    roc = diagnostic_knn$roc,
    filename = filename
)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

## Analysis of diagnostic models 

### Comparing model performance 

```{r}
diagnostic_models <- list(
  "svm" = list(
        "model" = diagnostic_svm$model,
        "confmat" = diagnostic_svm$confmat,
        "prediction" = diagnostic_svm$prediction,
        "auc" = as.numeric(diagnostic_svm$roc$auc)
    ),

    "knn" = list(
      "model" = diagnostic_knn$model,
      "confmat" = diagnostic_knn$confmat,
      "prediction" = diagnostic_knn$prediction,
      "auc" = as.numeric(diagnostic_knn$roc$auc)
    ),

    "rf" = list(
      "model" = diagnostic_rf$model,
      "confmat" = diagnostic_rf$confmat,
      "prediction" = diagnostic_rf$prediction,
      "auc" = as.numeric(diagnostic_rf$roc$auc)
    )
)
```

```{r}
knitr::kable(
  sigident::compare_diagnostic_models(diagnostic_models)
)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(diagnostic_svm, diagnostic_knn, diagnostic_rf,
   training_list)
gc()
```

### Model performance measurements

#### SVM

```{r}
diagnostic_models$svm$confmat
```

#### RF

```{r}
diagnostic_models$rf$confmat
```

#### KNN

```{r}
diagnostic_models$knn$confmat
```


## Validation of diagnostic signatures 

```{r}
validationstudylist <- list(
  "GSE30219" = list(
    setid = 1, 
    targetcolname = "source_name_ch1",
    controllevelname = "Non Tumoral Lung",
    targetlevelname = "Lung Tumour"
  ),
  "GSE33356" = list(
    setid = 1, 
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue: paired normal adjacent",
    targetlevelname = "tissue: lung cancer"
  ),
  "GSE102287" = list(
    setid = 2, 
    targetcolname = "characteristics_ch1.6",
    controllevelname = "tumor_normal status: N",
    targetlevelname = "tumor_normal status: T"
  )
)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results <- sigident::validate_diagnostic_signatures(
  validationstudylist = validationstudylist,
  models = diagnostic_models,
  genes = genes,
  idtype = idtype,
  datadir = datadir,
  colindices = 1:1000
)
```

### GSE302019 

#### SVM

```{r}
validation_results[["GSE30219"]]$svm$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_svm.png")
sigident::plot_rocplot(roc = validation_results[["GSE30219"]]$svm$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF

```{r}
validation_results[["GSE30219"]]$rf$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_rf.png")
sigident::plot_rocplot(roc = validation_results[["GSE30219"]]$rf$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN 

```{r}
validation_results[["GSE30219"]]$knn$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_knn.png")
sigident::plot_rocplot(roc = validation_results[["GSE30219"]]$knn$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results[["GSE30219"]] <- NULL
gc()
```

### GSE33356 

#### SVM

```{r}
validation_results[["GSE33356"]]$svm$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_svm.png")
sigident::plot_rocplot(roc = validation_results[["GSE33356"]]$svm$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF

```{r}
validation_results[["GSE33356"]]$rf$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_rf.png")
sigident::plot_rocplot(roc = validation_results[["GSE33356"]]$rf$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN

```{r}
validation_results[["GSE33356"]]$knn$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_knn.png")
sigident::plot_rocplot(roc = validation_results[["GSE33356"]]$knn$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results[["GSE33356"]] <- NULL
gc()
```

### GSE102287 

#### SVM

```{r}
validation_results[["GSE102287"]]$svm$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_svm.png")
sigident::plot_rocplot(roc = validation_results[["GSE102287"]]$svm$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF 

```{r}
validation_results[["GSE102287"]]$rf$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_rf.png")
sigident::plot_rocplot(roc = validation_results[["GSE102287"]]$rf$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN 

```{r}
validation_results[["GSE102287"]]$knn$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_knn.png")
sigident::plot_rocplot(roc = validation_results[["GSE102287"]]$knn$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results[["GSE102287"]] <- NULL
rm(validationstudylist, diagnostic_models, GSE102287, GSE33356)
gc()
```
