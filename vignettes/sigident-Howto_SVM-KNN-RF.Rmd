---
title: "sigident - Howto Microarray"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sigident-Howto_Microarray}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Prerequisites and installation 

## Install sigident.preproc package

```{r eval = FALSE}
options('repos' = 'https://ftp.fau.de/cran/')
install.packages("devtools")
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.preproc.git",
                      upgrade = "always")
```

## Install sigident package

```{r eval = FALSE}
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.git")
```

# Preprocessing 

In order to use this R package and its functions, you need to prepare a merged gene expression dataset. The workflow to achieve this is presented in the following by making use of the R package `sigident.preproc`.

For a detailed background on the following steps please view the `sigident.preproc` package's vignette.

## Initialization of important variables

```{r setup}
library(sigident)
library(sigident.preproc)
library(knitr)

# initialize filePath:
filePath <- tempdir()

# define datadir
maindir <- "./geodata/"
datadir <- paste0(maindir, "data/")
dir.create(maindir)
dir.create(datadir)

# define plotdir
plotdir <- "./plots/"
dir.create(plotdir)

# define idtype
idtype = "affy"
```

## Define list that contains a representation of the studies metadata

```{r}
studiesinfo <- list(
  "GSE18842" = list(
    setid = 1,
    targetcolname = "source_name_ch1",
    targetlevelname = "Human Lung Tumor",
    controllevelname = "Human Lung Control"
    ),
  
  "GSE19804" = list(
    setid = 1,
    targetcolname = "source_name_ch1",
    targetlevelname = "frozen tissue of primary tumor",
    controllevelname = "frozen tissue of adjacent normal"
  ),
  
  "GSE19188" = list(
    setid = 1,
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue type: healthy",
    targetlevelname = "tissue type: tumor",
    use_rawdata = TRUE
  )
)
```

## Load GEO datasets

All downloaded datasets will be assigned to the global environment.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
sigident.preproc::load_geo_data(
  studiesinfo = studiesinfo,
  datadir = datadir,
  plotdir = plotdir,
  idtype = idtype
) 
```

## Visualize batch effect

These plots are created when executing the function `sigident.preproc::load_geo_data` and stored in the directory specified in `plotdir`.

### Before batch correction

```{r out.width='80%'}
knitr::include_graphics(paste0(plotdir, "GSE18842_batch_effect_boxplot.jpg"))
knitr::include_graphics(paste0(plotdir, "GSE19804_batch_effect_boxplot.jpg"))
knitr::include_graphics(paste0(plotdir, "GSE19188_batch_effect_boxplot.jpg"))
knitr::include_graphics(paste0(plotdir, "Merged_before_batch_effect_boxplot.jpg"))
knitr::include_graphics(paste0(plotdir, "PCplot_before.png"))
```

### After batch correction

```{r out.width='80%'}
knitr::include_graphics(paste0(plotdir, "Merged_after_batch_effect_boxplot.jpg"))
knitr::include_graphics(paste0(plotdir, "PCplot_after.png"))
```

# Preparations for utilizing the sigident package 

Before using the `sigident` package, these variables need to be defined properly. One could use them also as arguments directly in the respective function. However, to keep the code clearer we define them here at the beginning and refer at each function to the respective variable. 
`idtype` and `plotdir` have already been defined during the preprocessing steps.

```{r}
# general
csvdir <- "./csv/"
dir.create(csvdir)

# enrichment analysis
species <- "Hs"
OrgDb <- "org.Hs.eg.db"
organism <- "hsa"
#pathwayid <- "hsa04110" # Cell Cycle
pathwayid <- "hsa04151" # PI3K-Akt

# diagnostic signature
seed <- 111
split <- 0.8
nfolds <- 10
```

# Identification of diagnostic signatures 

<!-- A common task regarding gene expression data is to distinguish between different groups or subtypes. In order to train a multi-gene classifier, a large amount of expression data is required. Due to the imbalance of features (p) versus observations (n), the application of an appropriate method is needed.   -->
<!-- The lasso regression and elastic net regularization are generalized linear models which are powerful and versatile methods for feature selection and are well suited in order to analyse genomic data with p >> n.   -->
<!-- Therefore, we implemented the elastic net regularization method for the identification of a diagnostic multi-gene signature.   -->

## Split data into training and test dataset

A statistical prediction model is usually trained on 70%-80% percent of the present data. `create_training_test_split` randomly splits the merged dataset into a training and a test set with the former defined value `split` regarding to a balanced distribution of the groups (here diagnosis). For reproducibility, a seed must be set.  

```{r}
training_list <- sigident::create_training_test_split(
  diagnosis = diagnosis,
  mergeset = mergeset,
  split = split,
  seed = seed
)
```

Regularization requires the selection of a tuning parameter (lambda) that determines the strength of regularization. The function `signature` performs an `nfolds` cross-validation to select the best lambda and additionally builds the predictive model. `seed` is again set for reproducibility. The plot depicts the mean squared error as the criteron for the 10-fold cross-validation and shows the optimal values of lambda and the appropriate number of selected features (genes) above the plot. The left dashed vertical line represents the log of the optimal value of lambda ('lambda min'), which results in the lowest prediction error and giving the most accurate model. The right dashed vertical line indicates the log of the lambda value resulting in a model with the smallest number of included variables but also lies within one standard error of the optimal value of lambda ('lambda 1se').
Furthermore, a ROC curve is plotted to visualize the performance measurement of the model.

## SVM regression

A support vector machine is a collection of supervised learning algorithms that use hyperplane graphing to analyze new, unlabeled data. In Support Vector Machine incoming data is categorized into one of two classes. For SVM models, each data point is interpreted as a p-dimensional vector, which the machine attempts to create a linear classifier by fitting the data point inside a hyperplane (p-1 dimension). 
So for classification, every input is turned into a point in n-dimensional space (n being the number of features), and the value of each feature defined as the value of a unique coordinate on the hyperplane. Classification is determined by finding the hyperplane that most clearly separates the two classes.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_svm <- sigident::signature(
  traininglist = training_list,
  type = "svm",
  nfolds = nfolds,
  seed = seed
)
filename <- paste0(plotdir, "CV_svm.png")
sigident::plot_cvplot(cv_obj = diagnostic_svm$fit_cv,
                      filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_SVM.min.png")
sigident::plot_rocplot(roc = diagnostic_svm$roc_min,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_SVM.1se.png")
sigident::plot_rocplot(roc = diagnostic_svm$roc_1se,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

## k-nearest neighbors regression 

The k-nearest neighbors algorithm, or kNN, is one of the simplest machine learning algorithms. Usually, k is a small, odd number - sometimes only 1. The larger k is, the more accurate the classification will be, but the longer it takes to perform the classification. It classifies an object into one of several classes by looking at the k elements of the training set that are closest to the one you want to classify, and letting them vote by majority on what that objectâ€™s class should be.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_knn <- sigident::signature(
  traininglist = training_list,
  type = "knn",
  nfolds = nfolds,
  seed = seed
)
filename <- paste0(plotdir, "CV_KNN.png")
sigident::plot_cvplot(cv_obj = diagnostic_knn$fit_cv,
                      filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_KNN.min.png")
sigident::plot_rocplot(roc = diagnostic_knn$roc_min,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_KNN.1se.png")
sigident::plot_rocplot(roc = diagnostic_knn$roc_1se,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

## random forest regression 

The random forest regression is a supervised learning algorithm that randomly creates and merges multiple decision trees into one forest. The goal is not to rely on a single learning model, but rather a collection of decision models to improve accuracy. The primary difference between this approach and the standard decision tree algorithms is that the root nodes feature splitting nodes are generated randomly.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_rf <- sigident::signature(
  traininglist = training_list,
  type = "random_forest",
  nfolds = nfolds,
  seed = seed
)
filename <- paste0(plotdir, "CV_RF.png")
sigident::plot_cvplot(cv_obj = diagnostic_rf$fit_cv,
                      filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_RF.min.png")
sigident::plot_rocplot(roc = diagnostic_rf$roc_min,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_RF.1se.png")
sigident::plot_rocplot(roc = diagnostic_rf$roc_1se,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```




## Analysis of diagnostic models 

### Comparing model performance  

These models can be included into a list and the performance metrices for classification can then be printed using the function `compare_diagnostic_models()`. This list includes all information of the respective models, which can be accessed by the following structure.  

```{r}
diagnostic_models <- list(
  "svm" = list(
    "CV" = diagnostic_svm$fit_cv,
    "min" = list("model" = diagnostic_svm$lambda_min,
                 "confmat" = diagnostic_svm$confmat_min,
                 "prediction" = diagnostic_svm$predicted_min,
                 "auc" = as.numeric(diagnostic_svm$roc_min$auc)
                 ),
    "1se" = list("model" = diagnostic_svm$lambda_1se,
                 "confmat" = diagnostic_svm$confmat_1se,
                 "prediction" = diagnostic_svm$predicted_1se,
                 "auc" = as.numeric(diagnostic_svm$roc_1se$auc)
                 )
  ),
  "knn" = list(
    "CV" = diagnostic_knn$fit_cv,
    "min" = list("model" = diagnostic_knn$lambda_min,
                 "confmat" = diagnostic_knn$confmat_min,
                 "prediction" = diagnostic_knn$predicted_min,
                 "auc" = as.numeric(diagnostic_knn$roc_min$auc)
                 ),
    "1se" = list("model" = diagnostic_knn$lambda_1se,
                 "confmat" = diagnostic_knn$confmat_1se,
                 "prediction" = diagnostic_knn$predicted_1se,
                 "auc" = as.numeric(diagnostic_knn$roc_1se$auc)
                 )
  ),
 "rf" = list(
    "CV" = diagnostic_rf$fit_cv,
    "min" = list("model" = diagnostic_rf$lambda_min,
                 "confmat" = diagnostic_rf$confmat_min,
                 "prediction" = diagnostic_rf$predicted_min,
                 "auc" = as.numeric(diagnostic_rf$roc_min$auc)
                 ),
    "1se" = list("model" = diagnostic_rf$lambda_1se,
                 "confmat" = diagnostic_rf$confmat_1se,
                 "prediction" = diagnostic_rf$predicted_1se,
                 "auc" = as.numeric(diagnostic_rf$roc_1se$auc)
                 )
  )
)
```

```{r}
knitr::kable(
  sigident::compare_diagnostic_models(diagnostic_models)
)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(diagnostic_svm, diagnostic_knn, diagnostic_rf,
   training_list)
gc()
```

### Extract lambda values 

A function `get_diagnostic_lambda_values` was designed, to extract the results of the cross validation.

```{r}
knitr::kable(
  sigident::get_diagnostic_lambda_values(diagnostic_models)
)
```

### Model performance measurements

Additionally, the confusion matrix and the calculated performance metrices can be printed out for each model. 

#### SVM (min)

```{r}
diagnostic_models$svm$min$confmat
```

#### SVM (1se)

```{r}
diagnostic_models$svm[["1se"]]$confmat
```

#### KNN (min)

```{r}
diagnostic_models$knn$min$confmat
```

#### KNN (1se)

```{r}
diagnostic_models$knn[["1se"]]$confmat
```

#### RF (min)

```{r}
diagnostic_models$rf$min$confmat
```

#### RF (1se)

```{r}
diagnostic_models$rf[["1se"]]$confmat
```

### Export selected IDs for each model 

The following function enables the extraction of the selected genes (Affy-IDs) for each model as csv file.

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$svm$min$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_svm_min.csv"))
```

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$svm[["1se"]]$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_svm_1se.csv"))
```

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$knn$min$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_knn_min.csv"))
```

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$knn[["1se"]]$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_knn_1se.csv"))
```

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$rf$min$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_rf_min.csv"))
```

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$rf[["1se"]]$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_rf_1se.csv"))
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(signaturegenes)
gc()
```

## Validation of diagnostic signatures 

The validation of diagnostic signatures is conducted using expression data of the studies "GSE30219", "GSE33356" and "GSE102287". We therefore need to create a list, holding meta information about the respective studies. 

All models can be provided via the argument 'model' to the function `validate_diagnostic_signature` using the previously created list `diagnostic_models`.

You have to create a list for each validation data that contains specifications of the validation study. The object must be named The list structure is as follows:  
- `studyname`: the GEO id of the validation study  
- `setid`: the index of the provided GEO set to be used    
- `targetcolname`: the name of the phenoData column containing the target-variable
- `controllevelname`: the level name of the controls of the column, specified in `targetcolname`
- `targetlevelname`: the level name of the subjects of interest in `targetcolname`

### GSE302019 

```{r}
validationstudylist <- list(studyname = "GSE30219",
                            setid = 1, 
                            targetcolname = "source_name_ch1",
                            controllevelname = "Non Tumoral Lung",
                            targetlevelname = "Lung Tumour")
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
GSE30219_validation <- sigident::validate_diagnostic_signature(
  validationstudylist = validationstudylist,
  models = diagnostic_models,
  genes = genes,
  idtype = idtype,
  datadir = datadir
)
```

#### SVM (min) 

```{r}
GSE30219_validation$svm$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_svm_min.png")
sigident::plot_rocplot(roc = GSE30219_validation$svm$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### SVM (1se) 

```{r}
GSE30219_validation$svm[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_svm_1se.png")
sigident::plot_rocplot(roc = GSE30219_validation$svm[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN (min) 

```{r}
GSE30219_validation$knn$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_knn_min.png")
sigident::plot_rocplot(roc = GSE30219_validation$knn$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN (1se) 

```{r}
GSE30219_validation$knn[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_knn_1se.png")
sigident::plot_rocplot(roc = GSE30219_validation$knn[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF (min) 

```{r}
GSE30219_validation$rf$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_rf_min.png")
sigident::plot_rocplot(roc = GSE30219_validation$rf$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF (1se) 

```{r}
GSE30219_validation$rf[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_rf_1se.png")
sigident::plot_rocplot(roc = GSE30219_validation$rf[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(GSE30219_validation)
gc()
```

### GSE33356 

```{r}
validationstudylist <- list(studyname = "GSE33356",
                            setid = 1, 
                            targetcolname = "tissue:ch1",
                            controllevelname = "paired normal adjacent",
                            targetlevelname = "lung cancer")
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
GSE33356_validation <- sigident::validate_diagnostic_signature(
  validationstudylist = validationstudylist,
  models = diagnostic_models,
  genes = genes,
  idtype = idtype,
  datadir = datadir
)
```

#### SVM (min) 

```{r}
GSE33356_validation$svm$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_svm_min.png")
sigident::plot_rocplot(roc = GSE33356_validation$svm$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### SVM (1se) 

```{r}
GSE33356_validation$svm[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_svm_1se.png")
sigident::plot_rocplot(roc = GSE33356_validation$svm[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN (min) 

```{r}
GSE33356_validation$knn$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_knn_min.png")
sigident::plot_rocplot(roc = GSE33356_validation$knn$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN (1se) 

```{r}
GSE33356_validation$knn[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_knn_1se.png")
sigident::plot_rocplot(roc = GSE33356_validation$knn[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF (min) 

```{r}
GSE33356_validation$rf$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_rf_min.png")
sigident::plot_rocplot(roc = GSE33356_validation$rf$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF (1se) 

```{r}
GSE33356_validation$rf[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_rf_1se.png")
sigident::plot_rocplot(roc = GSE33356_validation$rf[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(GSE33356_validation)
gc()
```

### GSE102287 

```{r}
validationstudylist <- list(studyname = "GSE102287",
                            setid = 2, 
                            targetcolname = "tumor_normal status:ch1",
                            controllevelname = "N",
                            targetlevelname = "T")
```

```{r}
GSE102287_validation <- sigident::validate_diagnostic_signature(
  validationstudylist = validationstudylist,
  models = diagnostic_models,
  genes = genes,
  idtype = idtype,
  datadir = datadir
)
```

#### SVM (min) 

```{r}
GSE102287_validation$svm$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_svm_min.png")
sigident::plot_rocplot(roc = GSE102287_validation$svm$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### SVM (1se) 

```{r}
GSE102287_validation$svm[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_svm_1se.png")
sigident::plot_rocplot(roc = GSE102287_validation$svm[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN (min) 

```{r}
GSE102287_validation$knn$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_knn_min.png")
sigident::plot_rocplot(roc = GSE102287_validation$knn$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN (1se) 

```{r}
GSE102287_validation$knn[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_knn_1se.png")
sigident::plot_rocplot(roc = GSE102287_validation$knn[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF (min) 

```{r}
GSE102287_validation$rf$min$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_rf_min.png")
sigident::plot_rocplot(roc = GSE102287_validation$rf$min$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF (1se) 

```{r}
GSE102287_validation$rf[["1se"]]$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_rf_1se.png")
sigident::plot_rocplot(roc = GSE102287_validation$rf[["1se"]]$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(GSE102287_validation, validationstudylist, diagnostic_models,
   GSE102287, GSE33356)
gc()
```

# Identification of prognostic signatures 

## Create a list that contains specifications of the study/studies that contain(s) survival time information 

For the calculation of a prognostic signature it is first required to transform the phenoData containing the relevant survival data. In our example, only the study GSE19188 contains information on a subjects survival.  
In order to make the subsequent analyses possible, the list `discoverystudies_w_timedata`, containing metainformation about the validation study needs to be created. This nested list needs to contain the following elements:  
- the studyname, which is the key for a list containing  
  + `setid`: the index of the provided GEO set to be used   
  + `timecol`: the phenoData columm name of the survival time  
  + `status`: a list, containing the elements `statuscol` (name of phenoData column containing the survival status), `levels` (a list containing the originally used level-names of `statuscol`, namely `alive`, `deceased`, `na`)  
  + `targetcolname`: the name of the phenoData column containing the target-variable  
  + `controllevelname`: the level name of the controls of the column, specified in `targetcolname`  
  + `targetlevelname`: the level name of the subjects of interest in `targetcolname`  
  + `use_rawdata`: a logical value (TRUE or FALSE) that indicates, if the study is imported from the raw data  
  
Since we already used the raw data above to load the study 'GSE19188' for the analyses of the DEGs, the enrichment analysis and the computation of the diagnostic signature, we here again import the study from the raw CEL files.  

```{r eval = TRUE}
discoverystudies_w_timedata <- list(
  "GSE19188" = list(
    setid = 1,
    timecol = "characteristics_ch1.2",
    status = list(
      statuscol = "characteristics_ch1.3",
      levels = list(alive = "status: alive",
                    deceased = "status: deceased",
                    na = "status: Not available")),
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue type: healthy",
    targetlevelname = "tissue type: tumor",
    use_rawdata = TRUE)
)
```


## Identification of survival correlated genes 

### Extract survival data 

Next, the survival data needs to be extracted. `get_survival_time` results in a table named `survival_data`, containing samples (in our example of the class tumor) as rows, survival time and if an event (death) happened as columns. Additionally, the expression values of the selected DEGs (provided as parameter 'genes') are added as columns to the table. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}

### Identification of survival correlated genes
survival_data <- sigident::get_survival_time(
  sample_metadata = sample_metadata,
  genes = genes,
  idtype = idtype,
  discoverystudies_w_timedata = discoverystudies_w_timedata,
  datadir = datadir
)
survival_table <- survival_data[["GSE19188"]]
```

```{r}
dim(survival_table)
head(survival_table[,1:4])
```

### Compute univariate cox regression 

Subsequently, an univariate Cox regression is conducted to identify survival correlated genes. The results containing the hazard rate within a 95% CI and corresponding p-values are exported as csv-file. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
surv_correlated <- sigident::univ_cox(survtable = survival_table,
                                      genes = genes)
# export table with survival correlated genes
data.table::fwrite(surv_correlated,
                   paste0(csvdir, "survival_correlated_genes.csv"))
```

```{r}
dim(surv_correlated)
head(surv_correlated)
```

## Prognostic classifier and Kaplan-Meier estimator

In order to build an unbiased classifier that speparates subjects into high risk and low risk groups, expression data from the remaining discovery studies are required. 

### Evaluate expression pattern (over-/underrepresentation)

The classifier takes the expression profiles of the identified survival correlated genes between tumor and non-tumor samples into account. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
classifier_studies <- c("GSE18842", "GSE19804")
expr_pattern <- sigident::generate_expression_pattern(
  classifier_studies = classifier_studies,
  sig_cov = surv_correlated,
  mergeset = mergeset,
  sample_metadata = sample_metadata
)
```

```{r}
dim(expr_pattern)
head(expr_pattern)
```

### Apply the prognostic classifier on validation dataset 

In order to apply the prognostic classifier on validation datasets, another list containing metainformation about these validation studies is required. This list (`validationstudiesinfo`) has the same structure as the above described list `discoverystudies_w_timedata`.  
However, the element `use_rawdata` is not allowed here. Furthermore, is allowed to to set `targetlevelname` to 'NULL', which indicates, that all included samples are of the class of interest and are taken into account to perform the analyses.  

#### Create a list that contains specifications of the study that contains the validation information

```{r eval = TRUE}
validationstudiesinfo <- list(
  "GSE30219" = list(
    setid = 1,
    timecol = "characteristics_ch1.9",
    status = list(
      statuscol = "characteristics_ch1.8",
      levels = list(alive = "status: ALIVE",
                    deceased = "status: DEAD",
                    na = "status: NTL")
    ),
    targetcolname = "source_name_ch1",
    controllevelname = "Non Tumoral Lung",
    targetlevelname = "Lung Tumour"),
  
  "GSE50081" = list(
    setid = 1,
    timecol = "characteristics_ch1.8",
    status = list(
      statuscol = "characteristics_ch1.9",
      levels = list(
        alive = "status: alive",
        deceased = "status: dead",
        na = NA)
    ),
    targetcolname = "characteristics_ch1.1",
    targetlevelname = NULL,
    controllevelname = NULL)
)
# if targetlevelname == NULL, the expression set will not be filtered further
# but instead, all samples will be used for calculations
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
p_c <- sigident::prognostic_classifier(
  pattern_com = expr_pattern,
  validationstudiesinfo = validationstudiesinfo,
  datadir = datadir,
  idtype = idtype
)
```

### Validation study: GSE30219  

Here we extract information on the study GSE30219.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
fit <- p_c[["GSE30219"]]$kaplan_estimator$fit
risktable <- p_c[["GSE30219"]]$risktable
```

```{r}
dim(risktable)
head(risktable)
```

#### View proportional hazards regression models

```{r}
p_c[["GSE30219"]]$kaplan_estimator$res_cox
```

```{r}
fit
```


#### Plot prognostic Kaplan-Meier plot

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE30219_Prognostic_Kaplan-Meier_Plot.png")
sigident::plot_survplot(
  fit = fit,
  risktable = risktable,
  filename = filename
)
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```

### Validation study: GSE50081

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
fit <- p_c[["GSE50081"]]$kaplan_estimator$fit
risktable <- p_c[["GSE50081"]]$risktable
```

```{r}
dim(risktable)
head(risktable)
```

#### View proportional hazards regression models

```{r}
p_c[["GSE50081"]]$kaplan_estimator$res_cox
```

```{r}
fit
```

#### Plot prognostic Kaplan-Meier plot

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE50081_Prognostic_Kaplan-Meier_Plot.png")
sigident::plot_survplot(
  fit = fit,
  risktable =risktable,
  filename = filename
)
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```

# An alternative workflow: four generic functions for signature identification 

In order to simplify the workflow described above, we wrapped all these functions into four big functions.

## Preprocessing: 

The preprocessing of the data needs to be conform with the above described approach. Here, all necessary objects are created, including `mergeset`, `mergedset`, `batch`, `diagnosis`, `design`.

### Define Variables

```{r eval = FALSE}
# initialize filePath:
filePath <- tempdir()
maindir <- "./geodata/"
datadir <- paste0(maindir, "data/")
dir.create(maindir)
dir.create(datadir)

# define more variables
plotdir <- "./plots/"
dir.create(plotdir)
csvdir <- "./csv/"
dir.create(csvdir)

# pathway
species <- "Hs"
OrgDb <- "org.Hs.eg.db"
organism <- "hsa"
pathwayid <- "hsa04151"

# diagnostig signature
seed <- 111
split <- 0.8
nfolds <- 10

# other variables
idtype = "affy"
fdr <- 0.05
```

## Run `sigidentDEG`-function

```{r eval = FALSE}
genes <- sigident::sigidentDEG(
  mergeset = mergeset,
  mergedset = mergedset,
  sample_metadata = sample_metadata,
  design = design,
  idtype = idtype,
  fdr = fdr,
  plotdir = plotdir,
  csvdir = csvdir
)
```

## Run `sigidentEnrichment`-function

```{r eval = FALSE}
sigident::sigidentEnrichment(
  mergeset = mergeset,
  mergedset = mergedset,
  idtype = idtype,
  design = design,
  species = species,
  org_db = OrgDb,
  organism = organism,
  pathwayid = pathwayid,
  plotdir = plotdir,
  csvdir = csvdir
)
```
```{r eval = FALSE}
filename <- paste0(plotdir, "/", pathwayid, ".png")
knitr::include_graphics(filename)
```
```{r eval = FALSE}
filename <- paste0(plotdir, "/", pathwayid, ".pathview.png")
knitr::include_graphics(filename)
```

## Run `sigidentDiagnostic`-function 

```{r eval = FALSE}
diagnostic_models <- sigident::sigidentDiagnostic(
  mergeset = mergeset,
  diagnosis = diagnosis,
  seed = seed,
  nfolds = nfolds,
  split = split,
  plotdir = plotdir
)
```

```{r eval = FALSE}
knitr::kable(
  sigident::compare_diagnostic_models(diagnostic_models)
)
```

```{r eval = FALSE}
knitr::kable(
  sigident::get_diagnostic_lambda_values(diagnostic_models)
)
```

### Validation of the diagnostic signatures 

Some users may validate the resulting models using new data sets. This can be conducted running the function `validate_diagnostic_signature`. First, a list containing meta information on the validation study must be created.

```{r eval = FALSE}
validationstudylist <- list(
  studyname = "GSE30219",
  setid = 1, 
  targetcolname = "source_name_ch1",
  controllevelname = "Non Tumoral Lung",
  targetlevelname = "Lung Tumour"
)
```

```{r eval = FALSE}
GSE30219_validation <- sigident::validate_diagnostic_signature(
  validationstudylist = validationstudylist,
  models = diagnostic_models,
  genes = genes,
  idtype = idtype,
  datadir = datadir
)
```

## Run `sigidentPrognostic`-Function 

### First, define meta information lists

```{r eval = FALSE}
discoverystudies_w_timedata <- list(
  "GSE19188" = list(
    setid = 1,
    timecol = "characteristics_ch1.2",
    status = list(
      statuscol = "characteristics_ch1.3",
      levels = list(
        alive = "status: alive",
        deceased = "status: deceased",
        na = "status: Not available")
    ),
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue type: healthy",
    targetlevelname = "tissue type: tumor",
    use_rawdata = TRUE)
)

validationstudiesinfo <- list(
  "GSE30219" = list(
    setid = 1,
    timecol = "characteristics_ch1.9",
    status = list(
      statuscol = "characteristics_ch1.8",
      levels = list(
        alive = "status: ALIVE",
        deceased = "status: DEAD",
        na = "status: NTL")
    ),
    targetcolname = "source_name_ch1",
    controllevelname = "Non Tumoral Lung",
    targetlevelname = "Lung Tumour"
  ),
  
  "GSE50081" = list(
    setid = 1,
    timecol = "characteristics_ch1.8",
    status = list(
      statuscol = "characteristics_ch1.9",
      levels = list(
        alive = "status: alive",
        deceased = "status: dead",
        na = NA)
    ),
    targetcolname = "characteristics_ch1.1",
    targetlevelname = NULL,
    controllevelname = NULL)
)
# if targetlevelname == NULL, the expression set will not be filtered further
# but instead, all samples will be used for calculations
```

### Then run the analysis 

```{r eval = FALSE}
progn_results <- sigident::sigidentPrognostic(
  mergeset = mergeset,
  sample_metadata = sample_metadata,
  idtype = idtype,
  genes = genes,
  discoverystudies_w_timedata = discoverystudies_w_timedata,
  classifier_studies = c("GSE18842", "GSE19804"),
  validationstudiesinfo = validationstudiesinfo,
  datadir = datadir,
  plotdir = plotdir,
  csvdir = csvdir
)
```

```{r eval = FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE30219_Prognostic_Kaplan-Meier_Plot.png")
```

```{r eval = FALSE}
knitr::include_graphics(filename)
```

```{r eval = FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE50081_Prognostic_Kaplan-Meier_Plot.png")
```

```{r eval = FALSE}
knitr::include_graphics(filename)
```

# References 

[1] W.E. Johnson, C. Li, and A. Rabinovic. Adjusting batch effects in microarray data using empirical bayes methods. Biostatistics, 8(1):118â€“127, 2007.
