---
title: "sigident - Howto"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sigident-Howto}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(sigident)
library(knitr)
```

# Prerequisites & Data Preparation 

In order to use this R package and its functions, you need to prepare a merged gene expression dataset. 
This example uses the GEO datasets "GSE18842", "GSE19804" and "GSE19188", which contain #TODO here!!!!

## Download of GEO datasets & Normalization 

```{r}
# initialize filePath:
filePath <- tempdir()
dir.create("./geodata/")
plotdir <- "./plots/"
dir.create(plotdir)
csvdir <- "./csv/"
dir.create(csvdir)

#--------------#
###### 1. Download of GEO datasets & Normalization #####
#------------------------------------------------------#

# insert the desired GEO dataset into the getGEO() function
GSE18842 <- GEOquery::getGEO("GSE18842")
GSE19804 <- GEOquery::getGEO("GSE19804")
# extract expressionSets
eset1 <- GSE18842[[1]]
eset2 <- GSE19804[[1]]


# download raw data, uncompress them and execute GCRMA normalization 
# actually not necessary for GSE19188 but to showcase feasibility of dealing with .CEL files

GEOquery::getGEOSuppFiles("GSE19188", baseDir = filePath)
utils::untar("./GSE19188/GSE19188_RAW.tar", exdir="./geodata")
cels <- list.files("./geodata/", pattern = "[gz]")
sapply(paste("./geodata", cels, sep="/"), GEOquery::gunzip)
cels

# at this point, first the textfile "phenodata.txt must be generated
## For downloading raw data use the function: getGEOSuppFiles(""). After downloading and uncompressing the raw file (*_RAW.tar) we need to capture 
## the experimental information. Therefore a text file is created in the terminal window or rather in the command line.
system("bash -c 'ls ./geodata/*.CEL > ./geodata/phenodata.txt'")
## The command: ls data/*.CEL > data/phenodata.txt puts all .CEl files in one text file. 
## After this step the normalization can be started. 

celfiles <- affy::ReadAffy(filenames = cels, celfile.path = filePath) 
esetC <- gcrma::gcrma(celfiles, fast = TRUE)

# esetC = now is a normalized expressionSet, but without f- and pData
# the f- and pData are transfered manually from dataset GSE19188

GSE19188 <- GEOquery::getGEO("GSE19188")
eset3 <- GSE19188[[1]]
pData3 <- Biobase::pData(eset3)
fData3 <- Biobase::fData(eset3)
Biobase::pData(esetC) <- pData3
Biobase::fData(esetC) <- fData3
colnames(Biobase::exprs(esetC)) <- colnames(Biobase::exprs(eset3))
Biobase::annotation(esetC) <- Biobase::annotation(eset3)
eset3 <- esetC
```

## Formatting the phenoData 

```{r}
#-------------------------------------#
##### 2. Formatting the phenoData #####
#-------------------------------------#

# the phenoData of the expresssionSets must be formatted in such a way as that the phenoData columns overlap perfectly
# all expressionSets should have the same columns in the same order
# not consistent columns must get removed
# for simpler handling only phenoData columns of interest should be retained 
# we here retained all consistent phenoData

# create version b, that original expressionSets persist
eset1b <- eset1
eset2b <- eset2
eset3b <- eset3

# show number of samples and phenoData columns
dim(Biobase::pData(eset1b))
dim(Biobase::pData(eset2b))
dim(Biobase::pData(eset3b))
# depict phenoData column names
colnames(Biobase::pData(eset1b))
colnames(Biobase::pData(eset2b))
colnames(Biobase::pData(eset3b))


# remove unnecessary phenoData 
# rename desired column names and if necessary the column entries (as we did for 'Tumor') 

# eset1b
eset1b$relation <- NULL
eset1b$characteristics_ch1 <- NULL
eset1b$`sample type:ch1` <- NULL
eset1b$`tissue:ch1` <- NULL
colnames(Biobase::pData(eset1b))[8] = "Tumor"
levels(Biobase::eset1b$Tumor) = c("Control","Lung Cancer")
dim(eset1b)


# eset2b
eset2b$characteristics_ch1.2 <- NULL
eset2b$characteristics_ch1.3 <- NULL
eset2b$contact_department <- NULL
eset2b$characteristics_ch1 <- NULL
eset2b$`age:ch1` <- NULL
eset2b$`gender:ch1` <- NULL
eset2b$`stage:ch1` <- NULL
eset2b$`tissue:ch1` <- NULL
colnames(pData(eset2b))[8] = "Tumor"
levels(eset2b$Tumor) = c("Control","Lung Cancer")
dim(eset2b)


# eset3b
eset3b$characteristics_ch1.2 <- NULL
eset3b$characteristics_ch1.3 <- NULL
eset3b$characteristics_ch1.4 <- NULL
eset3b$contact_phone <- NULL
eset3b$contact_fax <- NULL
eset3b$contact_department <- NULL
eset3b$contact_web_link <- NULL
eset3b$relation <- NULL
eset3b$source_name_ch1 <- NULL
colnames(Biobase::pData(eset3b))[9] = "Tumor"
levels(eset3b$Tumor) = c("Control","Lung Cancer")
pNew <- Biobase::pData(eset3b)[,c(1:7,9,8,10:29)] # reorder columns
Biobase::pData(eset3b) = pNew
dim(eset3b)

# now, all phenoData columns are consistent
cbind(colnames(Biobase::pData(eset1b)), colnames(Biobase::pData(eset2b)), colnames(Biobase::pData(eset3b)))
```

## Checking normalization 

```{r}
#-----------------------------------#
##### 3. Checking normalization #####
#-----------------------------------#

graphics::boxplot(Biobase::exprs(eset1b))
graphics::boxplot(Biobase::exprs(eset2b))
graphics::boxplot(Biobase::exprs(eset3b))

#overview of how many tumor and cancer samples are in esets
table(Biobase::pData(eset1b)[,"Tumor"])
table(Biobase::pData(eset2b)[,"Tumor"])
table(Biobase::pData(eset3b)[,"Tumor"])
```

## Merging 

```{r}
#-----------------------------------------#
##### 4. Merging and Batch Correction #####
#-----------------------------------------#

esets <- c(eset1b,eset2b,eset3b)
mergeset <- sigident::merge_(esets)
# merging 3 esets, resulting in a mergeset containing 367 samples and 54675 genes

filename <- paste0(plotdir, "import_histogram.png")
sigident::createImportHistogram_(mergeset, filename)
```

```{r}
knitr::include_graphics(filename)
```



# Discovering Batch Effects  

```{r}
dd <- sigident::createDiagnosisDesign_(mergeset, controlname = "Control", targetname = "Lung Cancer")
diagnosis <- dd[["diagnosis"]]
design <- dd[["design"]]

DF <- sigident::createDataMatrix_(mergeset)
batch <- sigident::createBatch_(eset1b, eset2b, eset3b)
combat <- sigident::createCombat_(DF, batch, design)

gPCA_before <- sigident::batchCorrection_(DF, batch)
filename <- paste0(plotdir, "PCplot_before.png")
createBatchPlot_(gPCA_before, filename, "before")
```

```{r}
knitr::include_graphics(filename)
```

```{r}
gPCA_after <- sigident::batchCorrection_(combat, batch)
filename <- paste0(plotdir, "PCplot_after.png")
createBatchPlot_(gPCA_after, filename, "after")
```

```{r}
knitr::include_graphics(filename)
```

# DEG Analysis 

```{r}
q_selection <- NULL # use default setting
deg_q <- sigident::qSelection_(mergeset, q_selection)

genes <- sigident::identify.DEGs(BatchRemovedExprs = combat, design = design, qValue = deg_q)

# heatmap creation
filename <- paste0(plotdir, "DEG_heatmap.png")
# create colors for map
ht_colors <- unlist(lapply(mergeset$Tumor, colorHeatmap_, controlname)) # cancer = red
createDEGheatmap_(combat, genes, ht_colors, filename)
```

```{r}
knitr::include_graphics(filename)
```

```{r}
genelist <- geneMapping_(mergeset, genes)
deg_info <- exportDEGannotations_(mergeset, genes)
data.table::fwrite(deg_info, paste0(csvdir, "DEG_info.csv"))
```

```{r}
head(deg_info)
```

```{r}
deg_results <- limmaTopTable_(BatchRemovedExprs = combat, design = design, qValue = deg_q)
data.table::fwrite(deg_results, paste0(csvdir, "DEG_results.csv"))
```

```{r}
head(deg_results)
```
