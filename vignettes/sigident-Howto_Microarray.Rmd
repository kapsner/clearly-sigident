---
title: "sigident - Howto Microarray"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sigident-Howto_Microarray}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(sigident)
library(knitr)
library(mergeGEO)
```

# Prerequisites and Installation 

## Install sigident package

```{r eval=FALSE}
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.git")
```

# Data Preparation 

In order to use this R package and its functions, you need to prepare a merged gene expression dataset. 
This example uses the GEO lung cancer studies "GSE18842", "GSE19804" and "GSE19188", which contain in total 367 samples (197 tumor; 170 non-tumor) and 54,675 transcripts gained by using Affymetrix GeneChip Human Genome U133 Plus 2.0 Array (platform GPL570).

## Download of GEO datasets and normalization

TODO description

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# initialize filePath:
filePath <- tempdir()
maindir <- "./geodata/"
datadir <- paste0(maindir, "data/")
dir.create(maindir)
dir.create(datadir)

#------------------------------------------------------#
###### 1. Download of GEO datasets & Normalization #####
#------------------------------------------------------#

if (!file.exists(paste0(datadir, "GSE18842"))){
  # insert the desired GEO dataset into the getGEO() function
  GSE18842 <- GEOquery::getGEO("GSE18842", destdir = datadir)
  GSE19804 <- GEOquery::getGEO("GSE19804", destdir = datadir)
} else {
  GSE18842 <- GEOquery::getGEO(filename = paste0(datadir, "GSE18842"))
  GSE19804 <- GEOquery::getGEO(filename = paste0(datadir, "GSE19804"))
}
# extract expressionSets
eset1 <- GSE18842[[1]]
eset2 <- GSE19804[[1]]

# download raw data, uncompress them and execute GCRMA normalization
# actually not necessary for GSE19188 but to showcase feasibility of dealing with .CEL files

if (!file.exists(paste0(maindir, "phenodata.txt"))){
  GEOquery::getGEOSuppFiles("GSE19188", baseDir = filePath)
  utils::untar(paste0(filePath, "/GSE19188/GSE19188_RAW.tar"), exdir="./geodata")
  cels <- list.files("./geodata/", pattern = "[gz]")
  sapply(paste("./geodata", cels, sep="/"), GEOquery::gunzip)
  
  # at this point, first the textfile "phenodata.txt must be generated
  ## For downloading raw data use the function: getGEOSuppFiles(""). After downloading and uncompressing the raw file (*_RAW.tar) we need to capture
  ## the experimental information. Therefore a text file is created in the terminal window or rather in the command line.
  system("bash -c 'ls ./geodata/*.CEL > ./geodata/phenodata.txt'")
  ## The command: ls data/*.CEL > data/phenodata.txt puts all .CEl files in one text file.
  ## After this step the normalization can be started.
} else {
  cels <- list.files("./geodata/", pattern = "[gz]")
}

celfiles <- affy::ReadAffy(filenames = gsub("\\.gz", "", cels), celfile.path = "./geodata")
esetC <- gcrma::gcrma(celfiles, fast = TRUE)

# esetC = now is a normalized expressionSet, but without f- and pData
# the f- and pData are transfered manually from dataset GSE19188

GSE19188 <- GEOquery::getGEO("GSE19188")
eset3 <- GSE19188[[1]]
pData3 <- Biobase::pData(eset3)
fData3 <- Biobase::fData(eset3)
Biobase::pData(esetC) <- pData3
Biobase::fData(esetC) <- fData3
colnames(Biobase::exprs(esetC)) <- colnames(Biobase::exprs(eset3))
Biobase::annotation(esetC) <- Biobase::annotation(eset3)
eset3 <- esetC
```

## Formatting the phenoData

```{r}
#-------------------------------------#
##### 2. Formatting the phenoData #####
#-------------------------------------#

# the phenoData of the expresssionSets must be formatted in such a way as that the phenoData columns overlap perfectly
# all expressionSets should have the same columns in the same order
# not consistent columns must get removed
# for simpler handling only phenoData columns of interest should be retained
# we here retained all consistent phenoData

# create version b, that original expressionSets persist
eset1b <- eset1
eset2b <- eset2
eset3b <- eset3

# show number of samples and phenoData columns
dim(Biobase::pData(eset1b))
dim(Biobase::pData(eset2b))
dim(Biobase::pData(eset3b))
# depict phenoData column names
colnames(Biobase::pData(eset1b))
colnames(Biobase::pData(eset2b))
colnames(Biobase::pData(eset3b))


# remove unnecessary phenoData
# rename desired column names and if necessary the column entries (as we did for 'Tumor')

# eset1b
eset1b$relation <- NULL
eset1b$characteristics_ch1 <- NULL
eset1b$`sample type:ch1` <- NULL
eset1b$`tissue:ch1` <- NULL
colnames(Biobase::pData(eset1b))[8] = "target"
levels(Biobase::eset1b$target) = c("Control","Lung Cancer")
dim(eset1b)


# eset2b
eset2b$characteristics_ch1.2 <- NULL
eset2b$characteristics_ch1.3 <- NULL
eset2b$contact_department <- NULL
eset2b$characteristics_ch1 <- NULL
eset2b$`age:ch1` <- NULL
eset2b$`gender:ch1` <- NULL
eset2b$`stage:ch1` <- NULL
eset2b$`tissue:ch1` <- NULL
colnames(pData(eset2b))[8] = "target"
levels(eset2b$target) = c("Control","Lung Cancer")
dim(eset2b)


# eset3b
eset3b$characteristics_ch1.2 <- NULL
eset3b$characteristics_ch1.3 <- NULL
eset3b$characteristics_ch1.4 <- NULL
eset3b$contact_phone <- NULL
eset3b$contact_fax <- NULL
eset3b$contact_department <- NULL
eset3b$contact_web_link <- NULL
eset3b$relation <- NULL
eset3b$source_name_ch1 <- NULL
colnames(Biobase::pData(eset3b))[9] = "target"
levels(eset3b$target) = c("Control","Lung Cancer")
pNew <- Biobase::pData(eset3b)[,c(1:7,9,8,10:29)] # reorder columns
Biobase::pData(eset3b) = pNew
dim(eset3b)

# now, all phenoData columns are consistent
cbind(colnames(Biobase::pData(eset1b)), colnames(Biobase::pData(eset2b)), colnames(Biobase::pData(eset3b)))
```

## Checking normalization

```{r}
#-----------------------------------#
##### 3. Checking normalization #####
#-----------------------------------#

graphics::boxplot(Biobase::exprs(eset1b))
graphics::boxplot(Biobase::exprs(eset2b))
graphics::boxplot(Biobase::exprs(eset3b))

#overview of how many tumor and cancer samples are in esets
table(Biobase::pData(eset1b)[,"target"])
table(Biobase::pData(eset2b)[,"target"])
table(Biobase::pData(eset3b)[,"target"])
```



## Loading Metadata 

TODO Description here.

```{r}
studyMetadata <- mergeGEO::readStudyMetadata_(studymetadataFilename = paste0(metadatadir, studymetadata))
sampleMetadata <- mergeGEO::readSampleMetadata_(samplemetadataFilename = paste0(metadatadir, samplemetadata),
                                             studyMetadata = studyMetadata)
```

# Preparations for utilizing the sigident package 

These variables need to be defined for the package functions to work. One could use them also as arguments directly in the respective function. However, we think it is more clearly to define them here at the beginning and to refer at each function to the respective variable.  


```{r}
plotdir <- "./plots/"
dir.create(plotdir)
csvdir <- "./csv/"
dir.create(csvdir)
targetcol <- "target"
controlname <- "Control"
targetname <- "Lung Cancer"
species <- "Hs"
OrgDb <- "org.Hs.eg.db"
organism <- "hsa"
pathwayid <- "hsa04110"
seed <- 111
split <- 0.8
```

First, a boxplot is created with the included samples on the x-axis and the standardised expression values on the y-axis. `mergeset` results as output from the function `mergeGEO()` and represents a matrix containing the genes (Entrez ID) as rows and the samples as columns.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "import_boxplot.png")
sigident::createImportBoxplot_(mergeset, filename)
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```


# Create experiment desciption and visualize batch effects  

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
dd <- sigident::createDiagnosisDesign_(sampleMetadata = sampleMetadata,
                                       studyMetadata = studyMetadata,
                                       controlname = controlname,
                                       targetname = targetname,
                                       targetcol = targetcol)
diagnosis <- dd$diagnosis
design <- dd$design

batch <- sigident::createBatch_(studyMetadata = studyMetadata,
                                sampleMetadata = sampleMetadata)

gPCA_after <- sigident::batchCorrection_(mergeset = mergeset,
                                         batch = batch)
filename <- paste0(plotdir, "PCplot_after.png")
sigident::createBatchPlot_(correction_obj = gPCA_after,
                           filename = filename,
                           time = "after")
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```

# DEG Analysis 

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
q_selection <- NULL # use default setting
deg_q <- sigident::qSelection_(sampleMetadata = sampleMetadata,
                               deg.q.selection = q_selection)

genes <- sigident::identifyDEGs_(mergeset = mergeset,
                                 design = design,
                                 qValue = deg_q)

# heatmap creation
filename <- paste0(plotdir, "DEG_heatmap.png")
# create colors for map
ht_colors <- sigident::colorHeatmap_(sampleMetadata = sampleMetadata,
                                     studyMetadata = studyMetadata,
                                     targetcol = targetcol,
                                     controlname = controlname) # cancer = red
sigident::createDEGheatmap_(mergeset = mergeset,
                            genes = genes,
                            patientcolors = ht_colors,
                            filename = filename)
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```

<!-- TODO start here 13.9. Lorenz -->

<!-- ```{r} -->
<!-- deg_info <- exportDEGannotations_(mergeset = mergeset, -->
<!--                                   genes = genes) -->
<!-- data.table::fwrite(deg_info, paste0(csvdir, "DEG_info.csv")) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- knitr::kable(head(deg_info)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- deg_results <- limmaTopTable_(BatchRemovedExprs = combat, -->
<!--                               design = design, -->
<!--                               qValue = deg_q) -->
<!-- data.table::fwrite(deg_results, paste0(csvdir, "DEG_results.csv")) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- knitr::kable(head(deg_results)) -->
<!-- ``` -->

# Gene enrichment 

TODO Description here.

```{r}
deg_entrez <- unique(genes)
```


## Test for over-representation 

TODO Description here.

```{r}
enr_topgo <- sigident::extractGOterms_(entrez = deg_entrez,
                                       species = species)
```
```{r}
dim(enr_topgo)
knitr::kable(head(enr_topgo))
```

TODO Description here.

```{r}
enr_topkegg <- sigident::extractKEGGterms_(entrez = deg_entrez,
                                           species = species)
```
```{r}
dim(enr_topkegg)
knitr::kable(head(enr_topkegg))
```

TODO Description here.

```{r}
enr_fitlm <- sigident::goDiffReg_(mergeset = mergeset,
                                  design = design)

enr_fitlm_topgo <- sigident::extractGOterms_(entrez = enr_fitlm,
                                             species = species,
                                             FDR = 0.01)
data.table::fwrite(enr_fitlm_topgo, paste0(csvdir, "Top_GO_fitlm.csv"))
```
```{r}
dim(enr_fitlm_topgo)
knitr::kable(head(enr_fitlm_topgo))
```

```{r}
enr_fitlm_topkegg <- sigident::extractKEGGterms_(entrez = enr_fitlm,
                                                 species = species)
data.table::fwrite(enr_fitlm_topkegg, paste0(csvdir, "Top_KEGG_fitlm.csv"))
```
```{r}
dim(enr_fitlm_topkegg)
knitr::kable(head(enr_fitlm_topkegg))
```

## GO Analysis

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
enr_analysis <- sigident::goEnrichmentAnalysis_(entrez = deg_entrez,
                                                OrgDB = OrgDb,
                                                organism = organism,
                                                fitlm = enr_fitlm,
                                                pathwayid = pathwayid,
                                                species = organism,
                                                plotdir = plotdir)
```
```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "/", organism, "04110.png")
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```
```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "/", organism, "04110.pathview.png")
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "Enriched_GO.png")
sigident::createEnrichtedBarplot_(enrichmentobj = enr_analysis$go,
                                  type = "GO",
                                  filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "Enriched_KEGG.png")
sigident::createEnrichtedBarplot_(enrichmentobj = enr_analysis$kegg,
                                  type = "KEGG",
                                  filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```


# Identification of diagnostic signatures 

TODO Description here.

## Split data into training and test dataset

TODO Description here.

```{r}
training_list <- sigident::createTrainingTest_(diagnosis = diagnosis,
                                               mergeset = mergeset,
                                               split = split,
                                               seed = seed)
```

## Lasso regression

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_lasso <- sigident::signature_(traininglist = training_list,
                                         type = "lasso",
                                         nfolds = 10,
                                         seed = seed)
filename <- paste0(plotdir, "CV_lasso.png")
sigident::createCVPlot_(cv_obj = diagnostic_lasso$fitCV,
                        filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_Lasso.min.png")
sigident::createROCplot_(roc = diagnostic_lasso$roc.min,
                         filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_Lasso.1se.png")
sigident::createROCplot_(roc = diagnostic_lasso$roc.1se,
                         filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```


## Elastic net regression 

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_elasticnet <- sigident::signature_(traininglist = training_list,
                                              type = "elastic",
                                              alpha = 0.9,
                                              nfolds = 10,
                                              seed = seed)
filename <- paste0(plotdir, "CV_elasticNet.png")
sigident::createCVPlot_(cv_obj = diagnostic_elasticnet$fitCV,
                        filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_elasticNet.min.png")
sigident::createROCplot_(roc = diagnostic_elasticnet$roc.min,
                         filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_elasticNet.1se.png")
sigident::createROCplot_(roc = diagnostic_elasticnet$roc.1se,
                         filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```


## Gridsearch to find alpha and lambda

TODO Description here.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_glmGrid <- sigident::signature_(traininglist = training_list,
                                           type = "grid",
                                           nfolds = 10,
                                           seed = seed)
# plot model of gridsearch
filename <- paste0(plotdir, "Gridsearch_model.png")
sigident::createGridModelPlot_(model = diagnostic_glmGrid$caret.train,
                               filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# plot variable importance of gridsearch
filename <- paste0(plotdir, "Gridsearch_variable_importance.png")
sigident::createGridVarImpPlot_(model = diagnostic_glmGrid$caret.train,
                                filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_elasticNet.grid.png")
sigident::createROCplot_(roc = diagnostic_glmGrid$roc.elasticNet,
                         filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```




# An alternative workflow: one generic function 

In order to simplify the whole abovedescribed workflow, we wrapped all these functions into one big function.

## Preprocessing: 

TODO Description here.

### Merge data sets  

TODO Description here.

```{r eval = FALSE}
studymetadata = "lungcancer_study_metadata.csv"
samplemetadata = "lungcancer_sample_metadata.csv"
studyname <- "lungcancer"
denovo <- TRUE
metadatadir <- "./metadata/"
dir.create(metadatadir)

# copy prepared files to metadatadir
file.copy(from=system.file("./demofiles/lungcancer_study_metadata.csv",
                           package = "mergeGEO"),
          to="./metadata/lungcancer_study_metadata.csv")
file.copy(from=system.file("./demofiles/lungcancer_sample_metadata.csv",
                           package = "mergeGEO"),
          to="./metadata/lungcancer_sample_metadata.csv")

m <- mergeGEO::mergeGEO(studymetadata = studymetadata,
                        samplemetadata = samplemetadata,
                        studyname = studyname,
                        denovo = denovo,
                        metadatadir = metadatadir)
mergeset <- m$ematMergedDiscoveryAllClasses
```

### Read metadata 

TODO Description here.

```{r eval = FALSE}
studyMetadata <- mergeGEO::readStudyMetadata_(studymetadataFilename = paste0(metadatadir,
                                                                             studymetadata))
sampleMetadata <- mergeGEO::readSampleMetadata_(samplemetadataFilename = paste0(metadatadir,
                                                                                samplemetadata),
                                                studyMetadata = studyMetadata)
```

## Run `sigidentMicroarray`-Function 

TODO Description here.

```{r eval = FALSE}
diagnosticModels <- sigident::sigidentMicroarray(mergeset = mergeset,
                                                 controlname = "Control",
                                                 targetname = "Lung Cancer",
                                                 studyMetadata = studyMetadata,
                                                 sampleMetadata = sampleMetadata,
                                                 species = "Hs",
                                                 OrgDb = "org.Hs.eg.db",
                                                 organism = "hsa",
                                                 pathwayid = "hsa04110",
                                                 deg.q.selection = NULL,
                                                 seed = 111,
                                                 nfolds = 10,
                                                 split = 0.8,
                                                 plotdir = "./plots/",
                                                 csvdir = "./tables/",
                                                 targetcol = "target"))
```

